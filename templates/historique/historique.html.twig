{% extends 'base.html.twig' %}

{% block title %}Historique - EcoRide{% endblock %}

{% block body %}

<section class="hero-global hero-historique d-flex align-items-center text-center text-white position-relative">
  <div class="container">
    <h1 class="hero-title mb-3 text-white">Mes trajets</h1>
    <h2 class="hero-tagline mb-4 text-white">À venir, en cours et passés</h2>
  </div>
</section>

<section class="py-5 bg-light">
<div class="container">
<div class="row justify-content-center">
<div class="col-lg-10">

<div class="card ecoride-form shadow p-4 p-md-5 rounded-4">

{# =========================================================
   TRAJETS À VENIR
========================================================= #}
<h3 class="text-success fw-bold mb-1">Trajets à venir</h3>
<p class="text-muted small mb-3">Clique sur une ligne pour ouvrir le détail.</p>

{% if trajetsAvenir is empty %}
  <div class="text-center text-muted py-4">Aucun trajet à venir.</div>
{% else %}
<div class="table-responsive rounded-4 shadow-sm bg-white mb-5">
<table class="table table-hover align-middle mb-0">
<thead class="table-success">
<tr>
  <th>Départ</th>
  <th>Arrivée</th>
  <th>Date</th>
  <th>Coût</th>
  <th>Rôle</th>
  <th class="text-end">Action</th>
</tr>
</thead>
<tbody>
{% for item in trajetsAvenir %}
<tr class="clickable-row"
    data-href="{{ path('app_trajet_detail',{id:item.id}) }}">
  <td>{{ item.villeDepart }}</td>
  <td>{{ item.villeArrivee }}</td>
  <td>{{ item.dateDepart|date('d/m/Y H:i') }}</td>
  <td>{{ item.tokenCost }} ECR</td>
  <td>
    <span class="badge {{ item.role=='conducteur'?'bg-primary':'bg-info text-dark' }}">
      {{ item.role|capitalize }}
    </span>
  </td>
  <td class="text-end text-success fw-semibold">Ouvrir →</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

{# =========================================================
   TRAJETS EN COURS
========================================================= #}
<h3 class="text-warning fw-bold mb-1">Trajets en cours</h3>
<p class="text-muted small mb-3">Clique sur une ligne pour ouvrir le détail.</p>

{% if trajetsAConfirmer is empty %}
  <div class="text-center text-muted py-4">Aucun trajet en cours.</div>
{% else %}
<div class="table-responsive rounded-4 shadow-sm bg-white mb-5">
<table class="table table-hover align-middle mb-0">
<thead class="table-warning">
<tr>
  <th>Départ</th>
  <th>Arrivée</th>
  <th>Date</th>
  <th>Coût</th>
  <th>Rôle</th>
  <th>Statut</th>
  <th class="text-end">Action</th>
</tr>
</thead>
<tbody>
{% for item in trajetsAConfirmer %}
<tr class="clickable-row"
    data-href="{{ path('app_trajet_detail',{id:item.id}) }}">
  <td>{{ item.villeDepart }}</td>
  <td>{{ item.villeArrivee }}</td>
  <td>{{ item.dateDepart|date('d/m/Y H:i') }}</td>
  <td>{{ item.tokenCost }} ECR</td>

  <td>
    <span class="badge {{ item.role=='conducteur'?'bg-primary':'bg-info text-dark' }}">
      {{ item.role|capitalize }}
    </span>
  </td>

  {% set estTermine = item.conducteurConfirmeFin or item.passagerConfirmeFin %}
  <td>
    <span class="badge {{ estTermine ? 'bg-success' : 'bg-warning text-dark' }}">
      {{ estTermine ? 'Terminé' : 'En cours' }}
    </span>
  </td>

  <td class="text-end">

    {% if item.role=='conducteur' and not item.conducteurConfirmeFin %}
      <form method="post"
            action="{{ path('trajet_arrivee',{id:item.id}) }}"
            class="d-inline"
            onsubmit="return confirm('Marquer ce trajet comme terminé ?');">
        <button class="btn btn-success btn-sm rounded-pill px-3">Terminer</button>
      </form>

    {% elseif item.role=='passager' and not estTermine %}
      <form method="post"
            action="{{ path('trajet_annuler', {id: item.id}) }}"
            class="d-inline"
            onsubmit="return confirm('Annuler votre réservation ?');">
        <input type="hidden" name="_token" value="{{ csrf_token('annuler_trajet_' ~ item.id) }}">
        <input type="hidden" name="redirect" value="{{ path('app_home') }}">
        <button class="btn btn-outline-danger btn-sm rounded-pill px-3">Annuler</button>
      </form>
    {% else %}
      <span class="text-muted small">En attente</span>
    {% endif %}

  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

{# =========================================================
   TRAJETS PASSÉS
========================================================= #}
<h3 class="text-success fw-bold mb-1">Trajets passés</h3>
<p class="text-muted small mb-3">Clique sur une ligne pour ouvrir le détail.</p>

{% if historiques is empty %}
  <div class="text-center text-muted py-4">Aucun trajet terminé.</div>
{% else %}
<div class="table-responsive rounded-4 shadow-sm bg-white">
<table class="table table-hover align-middle mb-0">
<thead class="table-success">
<tr>
  <th>Départ</th>
  <th>Arrivée</th>
  <th>Date</th>
  <th>Coût</th>
  <th>Rôle</th>
  <th>Statut</th>
  <th class="text-end">Action</th>
</tr>
</thead>
<tbody>
{% for item in historiques %}
<tr class="clickable-row"
    data-href="{{ path('app_trajet_detail',{id:item.id}) }}">
  <td>{{ item.villeDepart }}</td>
  <td>{{ item.villeArrivee }}</td>
  <td>{{ item.dateDepart|date('d/m/Y H:i') }}</td>
  <td>{{ item.tokenCost }} ECR</td>

  <td>
    <span class="badge {{ item.role=='conducteur'?'bg-primary':'bg-info text-dark' }}">
      {{ item.role|capitalize }}
    </span>
  </td>

  {% set estTermine = item.conducteurConfirmeFin or item.passagerConfirmeFin %}
  <td>
    <span class="badge {{ estTermine ? 'bg-success' : 'bg-warning text-dark' }}">
      {{ estTermine ? 'Terminé' : 'En attente' }}
    </span>
  </td>

  <td class="text-end text-success fw-semibold">
    {% if item.role=='passager' and item.aDejaNote %}
      <span class="text-muted small">Déjà noté ✓</span>
    {% else %}
      Ouvrir →
    {% endif %}
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

</div>
</div>
</div>
</div>
</section>

{# =========================================================
   JS GLOBAL LIGNES CLIQUABLES
========================================================= #}
<script>
document.addEventListener('click', function(e){
  const row = e.target.closest('.clickable-row');
  if(!row) return;

  if(e.target.closest('a,button,form,input,select,textarea,label')) return;

  const href = row.dataset.href;
  if(href) window.location.href = href;
});
</script>

{% endblock %}
