{% extends 'base.html.twig' %}

{% block title %}Mes trajets - EcoRide{% endblock %}

{% block body %}

<section class="hero-global hero-historique text-center text-white">
  <div class="container">
    <h1 class="hero-title mb-3 text-white">Mes trajets</h1>
    <h2 class="hero-tagline mb-4 text-white">Trajets à venir et passés</h2>
  </div>
</section>

{# ============================================================
   BARRE DE RECHERCHE
   ============================================================ #}
<form id="search-form" class="eco-searchbar mx-auto mb-4" action="{{ path('app_recherche') }}" method="get">
  <input type="hidden" name="page" value="recherche">

  <div class="eco-search-field">
    <i class="bi bi-geo-alt text-success me-2"></i>
    <input type="text" class="form-control" name="ville_depart" placeholder="Départ" required>
  </div>

  <div class="eco-search-field">
    <i class="bi bi-flag text-success me-2"></i>
    <input type="text" class="form-control" name="ville_arrivee" placeholder="Arrivée" required>
  </div>

  <div class="eco-search-field">
    <i class="bi bi-calendar-event text-success me-2"></i>
    <input type="date" class="form-control" name="date_depart">
  </div>

  <button type="submit" class="eco-search-btn">Rechercher</button>
</form>

{# ============================================================
   CONTENU PRINCIPAL
   ============================================================ #}
<section class="py-5 bg-light">
  <div class="container">
    <div class="card shadow-sm rounded-4 border-0">
      <div class="card-body">

        {# ============================================================
           ONGLET : À VENIR
           ============================================================ #}
        <h3 class="mb-4 text-success fw-bold">Trajets à venir</h3>

        {% if trajetsAvenir is empty %}
          <p class="text-muted text-center py-4">Aucun trajet à venir.</p>
        {% else %}
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-success">
                <tr>
                  <th>Départ</th>
                  <th>Arrivée</th>
                  <th>Date</th>
                  <th>Coût</th>
                  <th>Rôle</th>
                  <th class="text-center">Statut</th>
                </tr>
              </thead>
              <tbody>
                {% for item in trajetsAvenir %}
                  {% set trajet = item.trajet %}
                  {% set role = item.role %}

                  <tr class="trajet-clickable"
                      data-href="{{ path('app_trajet_detail', { id: trajet.id }) }}"
                      style="cursor:pointer">

                    <td>{{ trajet.villeDepart }}</td>
                    <td>{{ trajet.villeArrivee }}</td>
                    <td>{{ trajet.dateDepart|date('d/m/Y H:i') }}</td>
                    <td>{{ trajet.tokenCost }} EcoCrédits ECR</td>

                    <td>
                      {% if role == 'conducteur' %}
                        <span class="badge bg-primary">Conducteur</span>
                      {% else %}
                        <span class="badge bg-info text-dark">Passager</span>
                      {% endif %}
                    </td>

                    <td class="text-center text-muted small">
                      En attente de départ
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

        {# ============================================================
           SECTION : PASSÉS
           ============================================================ #}
        <hr class="my-5">

        <h3 class="mb-4 text-success fw-bold">Trajets passés</h3>

        {% if trajetsPasses is empty %}
          <p class="text-muted text-center py-4">Aucun trajet terminé.</p>
        {% else %}
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-success">
                <tr>
                  <th>Départ</th>
                  <th>Arrivée</th>
                  <th>Date</th>
                  <th>Coût</th>
                  <th>Rôle</th>
                  <th>Status</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>

              <tbody>
                {% for item in trajetsPasses %}
                  {% set trajet = item.trajet %}
                  {% set role = item.role %}
                  {% set reservation = item.reservation %}

                  <tr class="trajet-clickable"
                      data-href="{{ path('app_trajet_detail', { id: trajet.id }) }}"
                      style="cursor:pointer">

                    <td>{{ trajet.villeDepart }}</td>
                    <td>{{ trajet.villeArrivee }}</td>
                    <td>{{ trajet.dateDepart|date('d/m/Y H:i') }}</td>
                    <td>{{ trajet.tokenCost }} EcoCrédits ECR</td>

                    <td>
                      {% if role == 'conducteur' %}
                        <span class="badge bg-primary">Conducteur</span>
                      {% else %}
                        <span class="badge bg-info text-dark">Passager</span>
                      {% endif %}
                    </td>

                    <td>
                      {% if role == 'conducteur' %}
                        {% if trajet.conducteurConfirmeFin %}
                          <span class="badge bg-success">Terminé</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">En attente conducteur</span>
                        {% endif %}
                      {% else %}
                        {% if reservation and reservation.passagerConfirmeFin %}
                          <span class="badge bg-success">Terminé</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">En attente passager</span>
                        {% endif %}
                      {% endif %}
                    </td>

                    <td class="text-center">
                      {% if role == 'conducteur' and not trajet.conducteurConfirmeFin %}
                        <a href="{{ path('trajet_fin_conducteur', { id: trajet.id }) }}"
                           class="btn btn-success btn-sm rounded-pill">
                          Valider fin
                        </a>
                      {% endif %}

                      {% if role != 'conducteur'
                            and reservation
                            and not reservation.passagerConfirmeFin %}
                        <a href="{{ path('trajet_fin_passager', { id: trajet.id }) }}"
                           class="btn btn-outline-success btn-sm rounded-pill">
                          Valider fin
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</section>

{% endblock %}
